# TaraSON — EXPANSION RULES (during flattening)
- TaraSON expansion defines **how to turn any valid JSON structure into a flat TaraSON record**.
- Expansion produces:
    - **one key for each leaf primitive**, and  
    - **one sentinel key for each container** (dict or array) encountered during traversal.
- All structure is encoded in **JSON-Pointer keys**; values remain **primitives only**, except for container sentinels.

---

- Expansion stores structural information using **sentinel lines**:

    **For dicts (JSON objects):**
    - JSON:  
      `{ "A": {"B": -3.14} }`
    - TaraSON:  
      `{ "/A": {}, "/A/B": -3.14 }`
    - Sentinel:  
      `"/A": {}`  
      signals that `/A` expands into a **dictionary**.

    **For arrays:**
    - JSON:  
      `{ "A": [-3.14] }`
    - TaraSON:  
      `{ "/A": [], "/A/0": -3.14 }`
    - Sentinel:  
      `"/A": []`  
      signals that `/A` expands into an **array**.

---

- Flattening converts all nested JSON values into canonical TaraSON:

    **Dicts (JSON objects)**  
    - Emit one sentinel entry: `/path/to/node → {}`  
    - Recursively flatten each key inside the dict.  
    - Each nested key increases the JSON-Pointer path.

    **Arrays**
    - Emit one sentinel entry: `/path/to/node → []`
    - Arrays are **dense by definition**, because TaraSON is defined over standard JSON.
    - Use **0-based numeric indices**, one for each actual array element.
    - Convert the index to a JSON-Pointer path segment.
        - `"/A/0"` corresponds to the first element, etc.
    - **Dense-array guarantee:** Every array index `i` in a valid TaraSON source satisfies  
      `0 ≤ i < length(array)` with **no holes** and **no missing indices**.

    **Scalars**
    - Become leaf entries:
        - `/path/to/value → primitive`

---

- **Leaf detection**
    - A leaf is any JSON primitive:
        - string, number, boolean, null
    - Each leaf produces a pair:  
      `(canonical key, primitive value)`.

- **Non-primitive leaves cause errors**
    - By construction, this cannot happen when flattening valid JSON.
    - Any unflattened dict/array appearing as a non-sentinel value is an implementation error.

---

- **Independence of keys**
    - Each canonical key functions as an independent fact.
    - There is no implied semantic relationship between keys except the structural path.

- **Final record**
    - A TaraSON record is the **union of all flattened facts**:
        - sentinel lines,
        - and primitive leaves.
    - After flattening, the structure is fully represented and the JSON-Pointer order is irrelevant until canonicalization.

